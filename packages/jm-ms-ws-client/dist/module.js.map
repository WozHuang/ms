{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const event = require('jm-event')\nconst log = require('jm-logger')\nconst utils = require('jm-ms-core').utils\nconst error = require('jm-err')\nconst WS = require('jm-net').WebSocket\n\nconst Err = error.Err\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nlet fnclient = function (_Adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = {uri: opts}\n    }\n\n    const {uri, timeout = Timeout, logger = log.logger} = opts\n    let {prefix = '',} = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    let path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    let id = 0\n    let cbs = {}\n\n    const ws = new WS(Object.assign({Adapter: _Adapter}, opts))\n    ws.connect(uri)\n\n    const doc = {\n      uri,\n      prefix,\n\n      onReady: function () {\n        return ws.onReady()\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        this.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n\n          const t = opts.timeout || timeout\n          setTimeout(() => {\n            if (cbs[id]) {\n              delete cbs[id]\n              const e = error.err(Err.FA_TIMEOUT)\n              reject(e)\n            }\n          }, t)\n\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        this.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        logger.debug('ws.send', ...arguments)\n        ws.send(...arguments)\n      },\n\n      close: function () {\n        ws.close()\n      }\n    }\n    event.enableEvent(doc)\n\n    let onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    ws\n      .on('message', message => {\n        logger.debug('ws.received', message)\n        onmessage(message)\n      })\n      .on('open', () => {\n        id = 0\n        cbs = {}\n        doc.emit('open')\n        logger.info('ws.opened')\n      })\n      .on('error', e => {\n        doc.emit('error', e)\n        logger.error('ws.error', e)\n      })\n      .on('close', event => {\n        doc.emit('close', event)\n        logger.info('ws.closed')\n      })\n      .on('heartBeat', () => {\n        doc.emit('heartBeat')\n        doc.request('/')\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead')\n        return doc.emit('heartDead')\n      })\n      .on('connect', () => {\n        doc.emit('connect')\n        logger.info('ws.connect')\n      })\n      .on('reconnect', () => {\n        doc.emit('reconnect')\n        logger.info('ws.reconnect')\n      })\n      .on('connectFail', () => {\n        doc.emit('connectFail')\n        logger.info('ws.connectFail')\n      })\n\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["value","resolve","apply","e","Promise","utils","require$$0","WS","require$$1","WebSocket","Err","error","Timeout","MAXID","errNetwork","err","FA_NETWORK","fnclient","_Adapter","opts","uri","timeout","logger","log","prefix","FA_PARAMS","path","getUriPath","id","cbs","ws","Object","assign","Adapter","connect","doc","onReady","request","preRequest","send","JSON","stringify","reject","t","setTimeout","FA_TIMEOUT","notify","connected","debug","arguments","close","event","enableEvent","onmessage","message","emit","json","parse","p","data","on","info","client","$","name","app","clientModules","wss","unuse"],"mappings":"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"}