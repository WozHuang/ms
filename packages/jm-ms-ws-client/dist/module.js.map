{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const event = require('jm-event')\nconst utils = require('jm-ms-core').utils\nconst error = require('jm-err')\n\nconst Err = error.Err\n\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nlet fnclient = function (_Adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = {uri: opts}\n    }\n    if (!opts.uri) throw error.err(error.Err.FA_PARAMS)\n    let Adapter = opts.Adapter || _Adapter\n    let doc = null\n    let uri = opts.uri\n    let timeout = opts.timeout || 0\n    let id = 0\n    let cbs = {}\n    let path = utils.getUriPath(uri)\n    let prefix = opts.prefix || ''\n    prefix = path + prefix\n    let ws = null\n    let autoReconnect = true\n    if (opts.reconnect === false) autoReconnect = false\n    let reconnectTimer = null\n    let reconnectionDelay = opts.reconnectionDelay || 5000\n    let DEFAULT_MAX_RECONNECT_ATTEMPTS = 0 // 默认重试次数0 表示无限制\n    let maxReconnectAttempts = opts.reconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS\n\n    doc = {\n      uri: uri,\n      prefix: prefix,\n      connected: false,\n      autoReconnect: autoReconnect,\n      reconnectAttempts: 0,\n      reconnectionDelay: reconnectionDelay,\n      maxReconnectAttempts: maxReconnectAttempts,\n\n      onReady: function () {\n        let self = this\n        return new Promise(function (resolve, reject) {\n          if (self.connected) return resolve(self.connected)\n          self.on('open', function () {\n            resolve(self.connected)\n          })\n        })\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        ws.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        ws.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        if (!this.connected) throw errNetwork\n        ws.send.apply(ws, arguments)\n      },\n      close: function () {\n        if (reconnectTimer) {\n          clearTimeout(reconnectTimer)\n          reconnectTimer = null\n        }\n        this.autoReconnect = false\n        this.reconnectAttempts = 0\n        if (!this.connected) return\n        ws.close()\n        ws = null\n      }\n    }\n    event.enableEvent(doc)\n\n    let onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    doc.connect = function () {\n      if (this.connected) return\n      if (ws) return\n      this.autoReconnect = autoReconnect\n      doc.emit('connect')\n      let self = doc\n      ws = new Adapter(this.uri)\n      ws.on('message', message => {\n        onmessage(message)\n      })\n      ws.on('open', () => {\n        id = 0\n        cbs = {}\n        self.connected = true\n        self.emit('open')\n      })\n      ws.on('error', event => {\n        doc.emit('error', event)\n      })\n      ws.on('close', event => {\n        self.connected = false\n        ws = null\n        self.emit('close', event)\n        if (self.autoReconnect) {\n          if (self.maxReconnectAttempts && self.reconnectAttempts >= self.maxReconnectAttempts) {\n            self.emit('connectFail')\n            return\n          }\n          self.reconnectAttempts++\n          self.emit('reconnect')\n          reconnectTimer = setTimeout(function () {\n            reconnectTimer = null\n            self.connect()\n          }, self.reconnectionDelay)\n        }\n      })\n    }\n    doc.connect()\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["value","f","Promise","e","reject","utils","require$$0","Err","error","MAXID","errNetwork","err","FA_NETWORK","fnclient","_Adapter","opts","uri","FA_PARAMS","Adapter","doc","timeout","id","cbs","path","getUriPath","prefix","ws","autoReconnect","reconnect","reconnectTimer","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","maxReconnectAttempts","reconnectAttempts","connected","onReady","self","resolve","on","request","preRequest","apply","send","JSON","stringify","notify","arguments","close","clearTimeout","event","enableEvent","onmessage","message","emit","json","parse","p","data","connect","setTimeout","client","$","name","app","clientModules","wss","unuse"],"mappings":"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"}