{"version":3,"file":"browser.js","sources":["../lib/browser/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/browser/index.js"],"sourcesContent":["const event = require('jm-event')\nconst error = require('jm-err')\n\nconst Err = error.Err\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nmodule.exports = class Adapter {\n  constructor (uri) {\n    event.enableEvent(this)\n    let ws = new WebSocket(uri) // eslint-disable-line\n    this.ws = ws\n    ws.onmessage = event => {\n      this.emit('message', event.data)\n    }\n    ws.onopen = () => {\n      this.emit('open')\n    }\n    ws.onerror = event => {\n      this.emit('error', event)\n    }\n    ws.onclose = event => {\n      this.emit('close', event)\n    }\n  }\n\n  send () {\n    if (!this.ws) throw errNetwork\n    this.ws.send.apply(this.ws, arguments)\n  }\n\n  close () {\n    if (!this.ws) throw errNetwork\n    this.ws.close.apply(this.ws, arguments)\n  }\n}\n","const event = require('jm-event')\nconst log = require('jm-logger')\nconst utils = require('jm-ms-core').utils\nconst error = require('jm-err')\nconst WS = require('jm-net').WebSocket\n\nconst Err = error.Err\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nlet fnclient = function (_Adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout = Timeout, logger = log.logger } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    let path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    let id = 0\n    let cbs = {}\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const doc = {\n      uri,\n      prefix,\n\n      onReady: function () {\n        return ws.onReady()\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        this.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n\n          const t = opts.timeout || timeout\n          setTimeout(() => {\n            if (cbs[id]) {\n              delete cbs[id]\n              const e = error.err(Err.FA_TIMEOUT)\n              reject(e)\n            }\n          }, t)\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        this.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        ws.send(...arguments)\n      },\n\n      close: function () {\n        ws.close()\n      }\n    }\n    event.enableEvent(doc)\n\n    let onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    ws\n      .on('message', message => {\n        onmessage(message)\n      })\n      .on('open', () => {\n        id = 0\n        cbs = {}\n        doc.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        doc.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        doc.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (doc.emit('heartBeat')) return true\n        doc.request('/', 'get').catch(e => {})\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return doc.emit('heartDead')\n      })\n      .on('connect', () => {\n        doc.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        doc.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        doc.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('../mdl')\n\nlet $ = mdl(Adapter)\nmodule.exports = $\n"],"names":["Err","error","errNetwork","err","FA_NETWORK","uri","event","enableEvent","ws","WebSocket","onmessage","emit","data","onopen","onerror","onclose","send","apply","arguments","close","value","f","Promise","e","reject","utils","require$$0","WS","require$$1","Timeout","MAXID","fnclient","_Adapter","opts","timeout","logger","log","prefix","FA_PARAMS","path","getUriPath","id","cbs","Object","assign","Adapter","connect","doc","onReady","request","preRequest","JSON","stringify","resolve","t","setTimeout","FA_TIMEOUT","notify","connected","message","json","parse","p","on","info","catch","client","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}