{"version":3,"file":"browser.js","sources":["../lib/browser/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/browser/index.js"],"sourcesContent":["const { EventEmitter } = require('jm-event')\nconst error = require('jm-err')\n\nconst Err = error.Err\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nmodule.exports = class Adapter extends EventEmitter {\n  constructor (uri) {\n    super({ async: true })\n    const ws = new WebSocket(uri) // eslint-disable-line\n    this.ws = ws\n    ws.onmessage = event => {\n      this.emit('message', event.data)\n    }\n    ws.onopen = () => {\n      this.emit('open')\n    }\n    ws.onerror = event => {\n      this.emit('error', event)\n    }\n    ws.onclose = event => {\n      this.emit('close', event)\n    }\n  }\n\n  send () {\n    if (!this.ws) throw errNetwork\n    this.ws.send.apply(this.ws, arguments)\n  }\n\n  close () {\n    if (!this.ws) throw errNetwork\n    this.ws.close.apply(this.ws, arguments)\n  }\n}\n","const event = require('jm-event')\nconst log = require('jm-logger')\nconst { utils } = require('jm-ms-core')\nconst error = require('jm-err')\nconst { WebSocket: WS } = require('jm-net')\n\nconst Err = error.Err\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nmodule.exports = function (_Adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout = Timeout, logger = log.logger } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    let path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    let id = 0\n    let cbs = {}\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const doc = {\n      uri,\n      prefix,\n\n      onReady: function () {\n        return ws.onReady()\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        this.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n\n          const t = opts.timeout || timeout\n          setTimeout(() => {\n            if (cbs[id]) {\n              delete cbs[id]\n              const e = error.err(Err.FA_TIMEOUT)\n              reject(e)\n            }\n          }, t)\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        this.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        ws.send(...arguments)\n      },\n\n      close: function () {\n        ws.close()\n      }\n    }\n    event.enableEvent(doc)\n\n    const onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    ws\n      .on('message', message => {\n        onmessage(message)\n      })\n      .on('open', () => {\n        id = 0\n        cbs = {}\n        doc.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        doc.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        doc.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (doc.emit('heartBeat')) return true\n        doc.request('/', 'get').catch(e => {})\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return doc.emit('heartDead')\n      })\n      .on('connect', () => {\n        doc.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        doc.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        doc.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return doc\n  }\n}\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('../mdl')\n\nmodule.exports = mdl(Adapter)\n"],"names":["EventEmitter","require$$0","Err","error","errNetwork","err","FA_NETWORK","uri","async","ws","WebSocket","onmessage","event","emit","data","onopen","onerror","onclose","send","apply","arguments","close","utils","WS","require$$1","Timeout","MAXID","_Adapter","opts","timeout","logger","log","prefix","FA_PARAMS","path","getUriPath","id","cbs","Object","assign","Adapter","connect","doc","onReady","request","preRequest","JSON","stringify","Promise","resolve","reject","t","setTimeout","e","FA_TIMEOUT","notify","connected","enableEvent","message","json","parse","p","on","info","client","fnclient","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}