{"version":3,"file":"browser.js","sources":["../lib/browser/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/browser/index.js"],"sourcesContent":["const event = require('jm-event')\nconst error = require('jm-err')\n\nconst Err = error.Err\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nmodule.exports = class Adapter {\n  constructor (uri) {\n    let self = this\n    event.enableEvent(this)\n    let ws = new WebSocket(uri)\n    this.ws = ws\n    ws.on('message', function (event) {\n      self.emit('message', event.data)\n    })\n    ws.onopen = () => {\n      self.emit('open')\n    }\n    ws.onerror = event => {\n      self.emit('error', event)\n    }\n    ws.onclose = event => {\n      self.emit('close', event)\n    }\n  }\n\n  send () {\n    if (!this.ws) throw errNetwork\n    this.ws.send.apply(this.ws, arguments)\n  }\n\n  close () {\n    if (!this.ws) throw errNetwork\n    this.ws.close.apply(this.ws, arguments)\n  }\n}\n","const event = require('jm-event')\nconst utils = require('jm-ms-core').utils\nconst error = require('jm-err')\n\nconst Err = error.Err\n\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nlet fnclient = function (_Adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = {uri: opts}\n    }\n    if (!opts.uri) throw error.err(error.Err.FA_PARAMS)\n    let Adapter = opts.Adapter || _Adapter\n    let doc = null\n    let uri = opts.uri\n    let timeout = opts.timeout || 0\n    let id = 0\n    let cbs = {}\n    let path = utils.getUriPath(uri)\n    let prefix = opts.prefix || ''\n    prefix = path + prefix\n    let ws = null\n    let autoReconnect = true\n    if (opts.reconnect === false) autoReconnect = false\n    let reconnectTimer = null\n    let reconnectionDelay = opts.reconnectionDelay || 5000\n    let DEFAULT_MAX_RECONNECT_ATTEMPTS = 0 // 默认重试次数0 表示无限制\n    let maxReconnectAttempts = opts.reconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS\n\n    doc = {\n      uri: uri,\n      prefix: prefix,\n      connected: false,\n      autoReconnect: autoReconnect,\n      reconnectAttempts: 0,\n      reconnectionDelay: reconnectionDelay,\n      maxReconnectAttempts: maxReconnectAttempts,\n\n      onReady: function () {\n        let self = this\n        return new Promise(function (resolve, reject) {\n          if (self.connected) return resolve(self.connected)\n          self.on('open', function () {\n            resolve(self.connected)\n          })\n        })\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        ws.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        ws.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        if (!this.connected) throw errNetwork\n        ws.send.apply(ws, arguments)\n      },\n      close: function () {\n        if (reconnectTimer) {\n          clearTimeout(reconnectTimer)\n          reconnectTimer = null\n        }\n        this.autoReconnect = false\n        this.reconnectAttempts = 0\n        if (!this.connected) return\n        ws.close()\n        ws = null\n      }\n    }\n    event.enableEvent(doc)\n\n    let onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    doc.connect = function () {\n      if (this.connected) return\n      if (ws) return\n      this.autoReconnect = autoReconnect\n      doc.emit('connect')\n      let self = doc\n      ws = new Adapter(this.uri)\n      ws.on('message', message => {\n        onmessage(message)\n      })\n      ws.on('open', () => {\n        id = 0\n        cbs = {}\n        self.connected = true\n        self.emit('open')\n      })\n      ws.on('error', event => {\n        doc.emit('error', event)\n      })\n      ws.on('close', event => {\n        self.connected = false\n        ws = null\n        self.emit('close', event)\n        if (self.autoReconnect) {\n          if (self.maxReconnectAttempts && self.reconnectAttempts >= self.maxReconnectAttempts) {\n            self.emit('connectFail')\n            return\n          }\n          self.reconnectAttempts++\n          self.emit('reconnect')\n          reconnectTimer = setTimeout(function () {\n            reconnectTimer = null\n            self.connect()\n          }, self.reconnectionDelay)\n        }\n      })\n    }\n    doc.connect()\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('../mdl')\n\nlet $ = mdl(Adapter)\nmodule.exports = $\n"],"names":["Err","error","errNetwork","err","FA_NETWORK","uri","self","event","enableEvent","ws","WebSocket","on","emit","data","onopen","onerror","onclose","send","apply","arguments","close","value","f","Promise","e","reject","utils","require$$0","MAXID","fnclient","_Adapter","opts","FA_PARAMS","Adapter","doc","timeout","id","cbs","path","getUriPath","prefix","autoReconnect","reconnect","reconnectTimer","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","maxReconnectAttempts","reconnectAttempts","connected","onReady","resolve","request","preRequest","JSON","stringify","notify","clearTimeout","onmessage","message","json","parse","p","connect","setTimeout","client","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}