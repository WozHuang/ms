{"version":3,"file":"jm-ms-ws-client.js","sources":["../lib/ws.js","../lib/mdl/fnclient.js","../lib/mdl/index.js","../lib/index.js"],"sourcesContent":["const event = require('jm-event')\nconst WebSocket = require('ws')\n\nmodule.exports = class Adapter {\n  constructor (uri) {\n    event.enableEvent(this)\n    let ws = new WebSocket(uri)\n    this.ws = ws\n    ws.on('message', (data, flags) => {\n      this.emit('message', data)\n    })\n    ws.onopen = () => {\n      this.emit('open')\n    }\n    ws.onerror = event => {\n      this.emit('error', event)\n    }\n    ws.onclose = event => {\n      this.emit('close', event)\n    }\n  }\n\n  send () {\n    this.ws.send(...arguments)\n  }\n\n  close () {\n    if (!this.ws) return\n    this.ws.close(...arguments)\n  }\n}\n","const event = require('jm-event')\nconst log = require('jm-logger')\nconst utils = require('jm-ms-core').utils\nconst error = require('jm-err')\nconst WS = require('jm-net').WebSocket\n\nconst Err = error.Err\n\nconst Timeout = 60000 // 请求超时时间 60 秒\nconst MAXID = 999999\nlet errNetwork = error.err(Err.FA_NETWORK)\n\nlet fnclient = function (_Adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n\n    const { uri, timeout = Timeout, logger = log.logger } = opts\n    let { prefix = '' } = opts\n\n    if (!uri) throw error.err(error.Err.FA_PARAMS)\n\n    let path = utils.getUriPath(uri)\n    prefix = path + prefix\n\n    let id = 0\n    let cbs = {}\n\n    const ws = new WS(Object.assign({ Adapter: _Adapter }, opts))\n    ws.connect(uri)\n\n    const doc = {\n      uri,\n      prefix,\n\n      onReady: function () {\n        return ws.onReady()\n      },\n\n      async request (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        opts.uri = this.prefix + (opts.uri || '')\n        if (id >= MAXID) id = 0\n        id++\n        opts.id = id\n        this.send(JSON.stringify(opts))\n        return new Promise((resolve, reject) => {\n          cbs[id] = {\n            resolve,\n            reject\n          }\n\n          const t = opts.timeout || timeout\n          setTimeout(() => {\n            if (cbs[id]) {\n              delete cbs[id]\n              const e = error.err(Err.FA_TIMEOUT)\n              reject(e)\n            }\n          }, t)\n        })\n      },\n\n      async notify (opts) {\n        await this.onReady()\n        opts = utils.preRequest.apply(this, arguments)\n        if (!this.connected) throw errNetwork\n        opts.uri = this.prefix + (opts.uri || '')\n        this.send(JSON.stringify(opts))\n      },\n\n      send: function () {\n        ws.send(...arguments)\n      },\n\n      close: function () {\n        ws.close()\n      }\n    }\n    event.enableEvent(doc)\n\n    let onmessage = function (message) {\n      doc.emit('message', message)\n      let json = null\n      try {\n        json = JSON.parse(message)\n      } catch (err) {\n        return\n      }\n      if (json.id) {\n        if (cbs[json.id]) {\n          let p = cbs[json.id]\n          let err = null\n          let doc = json.data\n          if (doc.err) {\n            err = error.err(doc)\n            p.reject(err)\n          } else {\n            p.resolve(doc)\n          }\n          delete cbs[json.id]\n        }\n      }\n    }\n\n    ws\n      .on('message', message => {\n        onmessage(message)\n      })\n      .on('open', () => {\n        id = 0\n        cbs = {}\n        doc.emit('open')\n        logger.info('ws.opened', uri)\n      })\n      .on('error', e => {\n        doc.emit('error', e)\n        logger.error('ws.error', uri)\n        logger.error(e)\n      })\n      .on('close', event => {\n        doc.emit('close', event)\n        logger.info('ws.closed', uri)\n      })\n      .on('heartBeat', () => {\n        if (doc.emit('heartBeat')) return true\n        doc.request('/', 'get').catch(e => {})\n        return true\n      })\n      .on('heartDead', () => {\n        logger.info('ws.heartDead', uri)\n        return doc.emit('heartDead')\n      })\n      .on('connect', () => {\n        doc.emit('connect')\n        logger.info('ws.connect', uri)\n      })\n      .on('reconnect', () => {\n        doc.emit('reconnect')\n        logger.info('ws.reconnect', uri)\n      })\n      .on('connectFail', () => {\n        doc.emit('connectFail')\n        logger.info('ws.connectFail', uri)\n      })\n\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (Adapter) {\n  let client = fnclient(Adapter)\n  let $ = function (name = 'ms-ws-client') {\n    let app = this\n    app.clientModules.ws = client\n    app.clientModules.wss = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.ws\n        delete app.clientModules.wss\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n","const Adapter = require('./ws')\nconst mdl = require('./mdl')\n\nlet $ = mdl(Adapter)\nmodule.exports = $\n"],"names":["uri","event","enableEvent","ws","WebSocket","on","data","flags","emit","onopen","onerror","onclose","send","arguments","close","value","f","Promise","e","reject","utils","require$$0","WS","require$$1","Err","error","Timeout","MAXID","errNetwork","err","FA_NETWORK","fnclient","_Adapter","opts","timeout","logger","log","prefix","FA_PARAMS","path","getUriPath","id","cbs","Object","assign","Adapter","connect","doc","onReady","request","preRequest","apply","JSON","stringify","resolve","t","setTimeout","FA_TIMEOUT","notify","connected","onmessage","message","json","parse","p","info","catch","client","$","name","app","clientModules","wss","unuse","mdl"],"mappings":"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"}