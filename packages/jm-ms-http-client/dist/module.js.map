{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const event = require('jm-event')\nconst error = require('jm-err')\nconst utils = require('jm-ms-core').utils\n\nlet fnclient = function (_adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n    if (!opts.uri) throw error.err(error.Err.FA_PARAMS)\n    let adapter = opts.adapter || _adapter\n    let uri = opts.uri\n    let timeout = opts.timeout || 0\n\n    let doc = {\n      async request (opts) {\n        opts = utils.preRequest.apply(this, arguments)\n        let headers = opts.headers || {}\n        let noHeaders = ['host', 'if-none-match', 'content-type', 'content-length', 'connection']\n        noHeaders.forEach(function (key) {\n          if (headers[key]) delete headers[key]\n        })\n        if (opts.ips) {\n          headers['x-forwarded-for'] = opts.ips.toString()\n        }\n        if (opts.lng) {\n          headers['lng'] = opts.lng\n        }\n\n        let _opts = {\n          method: opts.type || 'get',\n          timeout: opts.timeout || timeout,\n          headers: headers\n        }\n        let url = uri + opts.uri\n        try {\n          let doc = await adapter.request(url, opts.data, _opts)\n          let data = doc.data\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          return data\n        } catch (e) {\n          let data = null\n          e.response && e.response.data && (data = e.response.data)\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          data && (e.data = data)\n          throw e\n        }\n      },\n      async notify (opts) {\n        await this.request.apply(this, arguments)\n      },\n      onReady () {\n        return true\n      }\n    }\n    event.enableEvent(doc)\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (adapter) {\n  let client = fnclient(adapter)\n  let $ = function (name = 'ms-http-client') {\n    let app = this\n    app.clientModules.http = client\n    app.clientModules.https = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.http\n        delete app.clientModules.https\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["utils","require$$0","fnclient","_adapter","opts","uri","error","err","Err","FA_PARAMS","adapter","timeout","doc","request","arguments","preRequest","apply","headers","noHeaders","forEach","key","ips","toString","lng","_opts","method","type","url","data","e","response","notify","onReady","event","enableEvent","client","$","name","app","clientModules","http","https","unuse"],"mappings":"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"}