{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const event = require('jm-event')\nconst error = require('jm-err')\nconst utils = require('jm-ms-core').utils\n\nlet fnclient = function (_adapter) {\n  return function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = { uri: opts }\n    }\n    if (!opts.uri) throw error.err(error.Err.FA_PARAMS)\n    let adapter = opts.adapter || _adapter\n    let uri = opts.uri\n    let timeout = opts.timeout || 0\n\n    let doc = {\n      async request (opts) {\n        opts = utils.preRequest.apply(this, arguments)\n        let headers = opts.headers || {}\n        let noHeaders = ['host', 'if-none-match', 'content-type', 'content-length', 'connection']\n        noHeaders.forEach(function (key) {\n          if (headers[key]) delete headers[key]\n        })\n        if (opts.ips) {\n          headers['x-forwarded-for'] = opts.ips.toString()\n        }\n        if (opts.lng) {\n          headers['lng'] = opts.lng\n        }\n\n        let _opts = {\n          method: opts.type || 'get',\n          timeout: opts.timeout || timeout,\n          headers: headers\n        }\n        let url = uri + opts.uri\n        try {\n          let doc = await adapter.request(url, opts.data, _opts)\n          let data = doc.data\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          return data\n        } catch (e) {\n          let data = null\n          e.response && e.response.data && (data = e.response.data)\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          data && (e.data = data)\n          throw e\n        }\n      },\n      async notify (opts) {\n        await this.request.apply(this, arguments)\n      },\n      onReady () {\n        return true\n      }\n    }\n    event.enableEvent(doc)\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (adapter) {\n  let client = fnclient(adapter)\n  let $ = function (name = 'ms-http-client') {\n    let app = this\n    app.clientModules.http = client\n    app.clientModules.https = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.http\n        delete app.clientModules.https\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["utils","require$$0","fnclient","_adapter","opts","uri","error","err","Err","FA_PARAMS","adapter","timeout","doc","request","preRequest","apply","headers","noHeaders","forEach","key","ips","toString","lng","_opts","method","type","url","data","e","response","notify","onReady","event","enableEvent","client","$","name","app","clientModules","http","https","unuse"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,IAAMA,KAAK,GAAGC,4BAAqB,CAACD,KAApC;;AAEA,IAAIE,QAAQ,GAAG,SAAXA,QAAW,CAAUC,QAAV,EAAoB;AACjC,SAAO,YAAqB;AAAA,QAAXC,IAAW,uEAAJ,EAAI;;AAC1B,QAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC5BA,MAAAA,IAAI,GAAG;AAAEC,QAAAA,GAAG,EAAED;AAAP,OAAP;AACD;;AACD,QAAI,CAACA,IAAI,CAACC,GAAV,EAAe,MAAMC,yBAAK,CAACC,GAAN,CAAUD,yBAAK,CAACE,GAAN,CAAUC,SAApB,CAAN;AACf,QAAIC,OAAO,GAAGN,IAAI,CAACM,OAAL,IAAgBP,QAA9B;AACA,QAAIE,GAAG,GAAGD,IAAI,CAACC,GAAf;AACA,QAAIM,OAAO,GAAGP,IAAI,CAACO,OAAL,IAAgB,CAA9B;AAEA,QAAIC,GAAG,GAAG;AACFC,MAAAA,OADE,mBACOT,IADP,EACa;AAAA;AAAA;;AACnBA,QAAAA,IAAI,GAAGJ,KAAK,CAACc,UAAN,CAAiBC,KAAjB,mBAAP;AACA,YAAIC,OAAO,GAAGZ,IAAI,CAACY,OAAL,IAAgB,EAA9B;AACA,YAAIC,SAAS,GAAG,CAAC,MAAD,EAAS,eAAT,EAA0B,cAA1B,EAA0C,gBAA1C,EAA4D,YAA5D,CAAhB;AACAA,QAAAA,SAAS,CAACC,OAAV,CAAkB,UAAUC,GAAV,EAAe;AAC/B,cAAIH,OAAO,CAACG,GAAD,CAAX,EAAkB,OAAOH,OAAO,CAACG,GAAD,CAAd;AACnB,SAFD;;AAGA,YAAIf,IAAI,CAACgB,GAAT,EAAc;AACZJ,UAAAA,OAAO,CAAC,iBAAD,CAAP,GAA6BZ,IAAI,CAACgB,GAAL,CAASC,QAAT,EAA7B;AACD;;AACD,YAAIjB,IAAI,CAACkB,GAAT,EAAc;AACZN,UAAAA,OAAO,CAAC,KAAD,CAAP,GAAiBZ,IAAI,CAACkB,GAAtB;AACD;;AAED,YAAIC,KAAK,GAAG;AACVC,UAAAA,MAAM,EAAEpB,IAAI,CAACqB,IAAL,IAAa,KADX;AAEVd,UAAAA,OAAO,EAAEP,IAAI,CAACO,OAAL,IAAgBA,OAFf;AAGVK,UAAAA,OAAO,EAAEA;AAHC,SAAZ;AAKA,YAAIU,GAAG,GAAGrB,GAAG,GAAGD,IAAI,CAACC,GAArB;AAnBmB,kCAoBf;AAAA,wBACcK,OAAO,CAACG,OAAR,CAAgBa,GAAhB,EAAqBtB,IAAI,CAACuB,IAA1B,EAAgCJ,KAAhC,CADd,YACEX,GADF;AAEF,gBAAIe,IAAI,GAAGf,GAAG,CAACe,IAAf;;AACA,gBAAIA,IAAI,IAAIA,IAAI,CAACpB,GAAjB,EAAsB;AACpB,kBAAIqB,EAAC,GAAGtB,yBAAK,CAACC,GAAN,CAAUoB,IAAV,CAAR;;AACA,oBAAMC,EAAN;AACD;;AACD,mBAAOD,IAAP;AAPE;AAQH,SA5BkB,YA4BVC,CA5BU,EA4BP;AACV,cAAID,IAAI,GAAG,IAAX;AACAC,UAAAA,CAAC,CAACC,QAAF,IAAcD,CAAC,CAACC,QAAF,CAAWF,IAAzB,KAAkCA,IAAI,GAAGC,CAAC,CAACC,QAAF,CAAWF,IAApD;;AACA,cAAIA,IAAI,IAAIA,IAAI,CAACpB,GAAjB,EAAsB;AACpB,gBAAIqB,GAAC,GAAGtB,yBAAK,CAACC,GAAN,CAAUoB,IAAV,CAAR;;AACA,kBAAMC,GAAN;AACD;;AACDD,UAAAA,IAAI,KAAKC,CAAC,CAACD,IAAF,GAASA,IAAd,CAAJ;AACA,gBAAMC,CAAN;AACD,SArCkB;AAsCpB,OAvCO;AAwCFE,MAAAA,MAxCE,mBAwCM1B,IAxCN,EAwCY;AAAA;AAAA;;AAAA,6BACZ,OAAKS,OAAL,CAAaE,KAAb,qBADY;AAEnB,OA1CO;AA2CRgB,MAAAA,OA3CQ,qBA2CG;AACT,eAAO,IAAP;AACD;AA7CO,KAAV;AA+CAC,IAAAA,2BAAK,CAACC,WAAN,CAAkBrB,GAAlB;AACA,WAAOA,GAAP;AACD,GA1DD;AA2DD,CA5DD;;AA8DA,cAAc,GAAGV,QAAjB;;OChEc,GAAG,YAAA,CAAUQ,OAAV,EAAmB;AAClC,MAAIwB,MAAM,GAAGhC,UAAQ,CAACQ,OAAD,CAArB;;AACA,MAAIyB,CAAC,GAAG,SAAJA,CAAI,GAAmC;AAAA,QAAzBC,IAAyB,uEAAlB,gBAAkB;AACzC,QAAIC,GAAG,GAAG,IAAV;AACAA,IAAAA,GAAG,CAACC,aAAJ,CAAkBC,IAAlB,GAAyBL,MAAzB;AACAG,IAAAA,GAAG,CAACC,aAAJ,CAAkBE,KAAlB,GAA0BN,MAA1B;AAEA,WAAO;AACLE,MAAAA,IAAI,EAAEA,IADD;AAELK,MAAAA,KAAK,EAAE,iBAAM;AACX,eAAOJ,GAAG,CAACC,aAAJ,CAAkBC,IAAzB;AACA,eAAOF,GAAG,CAACC,aAAJ,CAAkBE,KAAzB;AACD;AALI,KAAP;AAOD,GAZD;;AAcAL,EAAAA,CAAC,CAACD,MAAF,GAAWA,MAAX;AACA,SAAOC,CAAP;;;;;"}