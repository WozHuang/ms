{"version":3,"file":"module.js","sources":["../lib/mdl/fnclient.js","../lib/mdl/index.js"],"sourcesContent":["const event = require('jm-event')\nconst error = require('jm-err')\nconst utils = require('jm-ms-core').utils\n\nlet fnclient = function (_adapter) {\n  return async function (opts = {}) {\n    if (typeof opts === 'string') {\n      opts = {uri: opts}\n    }\n    if (!opts.uri) throw error.err(error.Err.FA_PARAMS)\n    let adapter = opts.adapter || _adapter\n    let uri = opts.uri\n    let timeout = opts.timeout || 0\n\n    let doc = {\n      async request (opts) {\n        opts = utils.preRequest.apply(this, arguments)\n        let headers = opts.headers || {}\n        let noHeaders = ['host', 'if-none-match', 'content-type', 'content-length', 'connection']\n        noHeaders.forEach(function (key) {\n          if (headers[key]) delete headers[key]\n        })\n        if (opts.ips) {\n          headers['x-forwarded-for'] = opts.ips.toString()\n        }\n        if (opts.lng) {\n          headers['lng'] = opts.lng\n        }\n\n        let _opts = {\n          method: opts.type || 'get',\n          timeout: opts.timeout || timeout,\n          headers: headers\n        }\n        let url = uri + opts.uri\n        try {\n          let doc = await adapter.request(url, opts.data, _opts)\n          let data = doc.data\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          return data\n        } catch (e) {\n          let data = null\n          e.response && e.response.data && (data = e.response.data)\n          if (data && data.err) {\n            let e = error.err(data)\n            throw e\n          }\n          data && (e.data = data)\n          throw e\n        }\n      },\n      async notify (opts) {\n        await this.request.apply(this, arguments)\n      },\n      onReady () {\n        return true\n      }\n    }\n    event.enableEvent(doc)\n    return doc\n  }\n}\n\nmodule.exports = fnclient\n","const fnclient = require('./fnclient')\n\nmodule.exports = function (adapter) {\n  let client = fnclient(adapter)\n  let $ = function (name = 'ms-http-client') {\n    let app = this\n    app.clientModules.http = client\n    app.clientModules.https = client\n\n    return {\n      name: name,\n      unuse: () => {\n        delete app.clientModules.http\n        delete app.clientModules.https\n      }\n    }\n  }\n\n  $.client = client\n  return $\n}\n"],"names":["utils","require$$0","fnclient","_adapter","opts","uri","error","err","Err","FA_PARAMS","adapter","timeout","doc","request","preRequest","apply","headers","noHeaders","forEach","key","ips","toString","lng","_opts","method","type","url","data","e","response","notify","onReady","event","enableEvent","client","$","name","app","clientModules","http","https","unuse"],"mappings":"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"}